---
title: "Healthcare Insights and Sociodemographic Analysis of New York: A Comprehensive Analysis of Patient Records in 2013"
format: pdf
author: Abel Limachi, Austin Tran, Joel Villarino, and Krish Kumar (Group 3)
editor: visual
---

*(last updated 10/30/2023)*

**Introduction:**

In the context of the ever-evolving landscape of healthcare, our choice of dataset stems from the pressing need to delve into an in-depth analysis of the healthcare dynamics prevailing in today's society. New York, being one of the most densely populated states in the United States, presents a unique microcosm of diverse populations and a wide spectrum of urban and rural healthcare challenges. Motivated by the significance of understanding these complexities, our research group has selected a comprehensive dataset encompassing 2,428,905 patient records, representing healthcare interactions across various hospitals throughout New York in the year 2013.

This rich dataset spans a spectrum of information, including patient demographics, detailed medical records, financial aspects related to their hospitalization, and critical contextual information pertinent to each patient's stay. This extensive dataset holds immense potential for generating compelling visualizations and conducting statistical analyses, offering valuable insights into the intricacies of the New York healthcare system while also providing broader insights that can contribute to the understanding of healthcare systems more generally.

The following project contains different visualizations and statistics that will provide you more information on the different social and economic factors associated with patients in the state of New York in 2013.

**Dataset:**

2013 Hospital Inpatient Discharges in the State of New York 

*The following data set was received from the official New York State Health website on heath.data.ny.gov*

<https://health.data.ny.gov/Health/Hospital-Inpatient-Discharges-SPARCS-De-Identified/npsr-cm47/data> 

**From website:**

The Statewide Planning and Research Cooperative System (SPARCS) Inpatient De-identified File contains discharge level detail on patient characteristics, diagnoses, treatments, services, and charges. This data file contains basic record level detail for the discharge. The de-identified data file does not contain data that is protected health information (PHI) under HIPAA. The health information is not individually identifiable; all data elements considered identifiable have been redacted. For example, the direct identifiers regarding a date have the day and month portion of the date removed.

Discharges that are identified as Abortion will have some information redacted; Facility ID, Facility Name, Health Service Area, Hospital County, Operating Certificate, and all provider license numbers. Patient zip code is limited to the first three digits. Zip codes for population size less than 20,000 are blank. Out of State are "OOS'. Patient age is presented in age groups: 0 to 17, 18 to 29, 30 to 49, 50 to 69, and 70 or Older.

**Logistics:**

-   2,428,905 rows of patient data

-   34 columns 

    -   Health Service Area
    -   Hospital County
    -   Operating Certificate Number
    -   Facility ID, Facility Name
    -   Age Group, Zip Code (3 digit)
    -   Gender
    -   Race
    -   Ethnicity
    -   Length of Stay
    -   Type of Admission
    -   Patient Disposition
    -   Discharge Year
    -   CCS Diagnosis Code
    -   CCS Diagnosis Description
    -   CCS Procedure Code
    -   CCS Procedure Description
    -   APR DRG Code
    -   APR DRG Description
    -   APR MDC Code
    -   APR MDC Description
    -   APR Severity of Illness Code
    -   APR Severity of Illness
    -   APR Risk of Mortality
    -   APR Medical Surgical Description
    -   Payment Typology
    -   Payment Typology
    -   Birth Weight,
    -   Abortion Edit Indicator
    -   Emergency Department
    -   Total Charges
    -   Total Costs

<br />

\newpage

# Visualizations and Plots
```{r, warning = FALSE, message = FALSE}
#| echo: false
library(RSQLite)
library(readr)
library(dplyr)
library(xtable)


dcon <- dbConnect(SQLite(), dbname = "finalDB.db", timeout = 10)


```

```{r, fig.height = 6, fig.width = 9, message = FALSE, warning = FALSE}
#| echo: false
library(DBI)
library(RSQLite)
library(ggplot2)
library(sf)
library(tigris)
#| echo: false


query <- dbSendQuery(dcon, "
  SELECT `HospitalCounty`, Race, COUNT(*) as count
  FROM `2013data`
  WHERE `HealthServiceArea` = 'New York City' 
    AND Race IN ('Black/African American', 'White')
  GROUP BY `HospitalCounty`, `Race`
")


data <- dbFetch(query, -1)

ggplot(data, aes(x = `HospitalCounty`, y = `Race`, fill = count)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  labs(title = "Number of Black/Other Race Individuals on Medicaid in NYC", 
       x = "Borough", 
       y = "Race", 
       fill = "Count") +
  theme_minimal()

dbClearResult(query)

# Query the data
query <- dbSendQuery(dcon,"
  SELECT `HospitalCounty`, Race, COUNT(*) as count
  FROM `2013data`
  WHERE `HealthServiceArea` = 'New York City' 
    AND Race IN ('Black/African American', 'White')
  GROUP BY `HospitalCounty`, `Race`
"
)
data <- dbFetch(query, -1)

dbClearResult(query)

# Retrieve the NYC boroughs shape data and filter for the five boroughs
options(tigris_use_cache = TRUE)

# Retrieve the NYC boroughs shape data and filter for the five boroughs
ny_counties <- tigris::counties(state = "NY", cb = TRUE) %>%
  st_as_sf()


nyc_boroughs <- ny_counties[ny_counties$NAME %in% c("Bronx", "Kings", "Manhattan", "Queens", "Richmond"), ]

# Merge the data with the nyc_boroughs spatial object
data_sf <- merge(nyc_boroughs, data, by.x = "NAME", by.y = "HospitalCounty")

# Compute the centroids for the NYC boroughs for plotting circles
data_sf$centroid <- st_centroid(st_geometry(data_sf))
```


\newpage
```{r, warning = FALSE}
#| echo: false
# Plotting side-by-side maps
ggplot(data_sf) +
  geom_sf(aes(fill = NAME), color = "grey60", size = 0.5) +  # Borough fill
  geom_point(aes(x = st_coordinates(centroid)[, "X"], 
                 y = st_coordinates(centroid)[, "Y"], 
                 size = count, 
                 color = Race), 
             alpha = 0.7, show.legend = "point") +  # Plot circles based on count, color-coded by Race
  
  # Faceting for each race
  facet_wrap(~Race, ncol = 2) +
  
  # Custom color scale
  scale_color_manual(values = c("Black/African American" = "blue", "White" = "red"), name = "Race") +
  scale_size_continuous(name = "Count", breaks = c(500, 1000, 1500, 2000)) +  # Adjust the size scale for circles
  
  # Title and subtitles
  labs(title = "Number of Black vs. White Individuals on Medicaid in NYC Boroughs",
       subtitle = "Size of point indicates count, color indicates race") +
  
  # Minimal theme and customization
  theme_minimal() +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())


```
```{r}
#| echo: false
library(waffle)
library(patchwork)
query <- dbSendQuery(dcon,"
SELECT Race, APRSeverityofIllnessCode FROM '2013data';
                     ")
IllnessCodes <- dbFetch(query, -1)
dbClearResult(query)

waffle_data1 <- data.frame(count = table(IllnessCodes$APRSeverityofIllnessCode[IllnessCodes$Race == "Black/African American"])/2500)
waffle_data2 <- data.frame(count = table(IllnessCodes$APRSeverityofIllnessCode[IllnessCodes$Race == "White"])/5000)

layout(matrix(c(1, 2), nrow = 1))

plot1 <- waffle(waffle_data1, rows = 8, size = .5, 
            colors = c("#FFEDA0", "#FEB24C", "#FC4E2A", "#BD0026"), title = "Black/African Americans")
plot2 <- waffle(waffle_data2, rows = 8, size = .5, 
            colors = c("#FFEDA0", "#FEB24C", "#FC4E2A", "#BD0026"), title = "White")

arrange.plots <- plot1 + theme(plot.title = element_text(size = 10)) + plot2 + theme(plot.title = element_text(size = 10))
arrange.plots
```

# Average Total Charges by Race
```{r, fig.height = 7, fig.width = 5}
#| echo: false
library(ggplot2)
library(patchwork)


pregnant_womenQ <- dbSendQuery(dcon, "
    SELECT Race, TotalCharges
    FROM '2013data'
    WHERE APRMDCCode == 14 OR APRMDCCode == 15;")
pregnant_womenDF = dbFetch(pregnant_womenQ, -1)
dbClearResult(pregnant_womenQ)

plot_race2013 <- ggplot(pregnant_womenDF) + 
  aes(x = Race, y = TotalCharges) +
  stat_summary(fun = "mean", geom = "bar", fill = "salmon") +  # Calculate and plot averages
  labs(x = "Race", y = "Average Total Charges", title = "Average Total Charge by Race in 2013") +  # Customize axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 7))  # Rotate x-axis labels for


pregnant_womenQ2 <- dbSendQuery(dcon, "
    SELECT Race, TotalCharges
    FROM '2021data'
    WHERE APRMDCCode == 14 OR APRMDCCode == 15 AND Race != 'Multi-racial';")
pregnant_womenDF2 = dbFetch(pregnant_womenQ2, -1)
dbClearResult(pregnant_womenQ2)
  
plot_race2021 <- ggplot(pregnant_womenDF2) + 
  aes(x = Race, y = TotalCharges) +
  stat_summary(fun = "mean", geom = "bar", fill = "violet") +  # Calculate and plot averages
  labs(x = "Race", y = "Average Total Charges", title = "Average Total Charge by Race in 2021") +  # Customize axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 7))  # Rotate x-axis labels for


combined_plot_race <- plot_race2013 + plot_race2021
combined_plot_race
```
